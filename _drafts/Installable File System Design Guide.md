title: Installable File System Design Guide
date: 2015-07-15 19:50:50
updated: 2015-07-15 19:53:19
tags:
- 驱动
- windows
- minifilter

---

#Filter Manager Concepts

![Simplified I/O Stack with Filter Manager and Minifilter Drivers](/images/Minifilter_ac.png)

#Advantages of the Filter Manager Model

相比传统fs过滤驱动，有以下优势：
**更好的控制filter加载顺序**，minifilter可以在任何时刻加载到合适的位置(通过altitude)
**支持动态卸载**，传统过滤驱动不支持卸载
**只处理自己关心的IO操作**,
**更高效的利用内核堆栈**,
**减少代码冗余**,
**降低复杂度**，
**很容易监控新的IO操作**

#Filter Manager Support for Minifilter Drivers

**安装卸载**
minifilter驱动可以任意时刻加载，可以指定SERVICE_BOOT_START, SERVICE_SYSTEM_START, or SERVICE_AUTO_START，在系统启动时加载，也可以在系统运行时，通过(sc start, net start, fltmc load, FltLoadFilter, or FilterLoad)加载。
在DriverEntry中调用FltRegisterFilter注册minifilter，当一切准备好后，调用FltStartFiltering接受volume attach，过滤IO操作。
filter manager检测可用的volume并自动调用InstanceSetupCallback通知minifilter去绑定新卷，也可以通过fltmc attach, FltAttachVolume, or FilterAttach通知filter manager主动触发调用
当minifilter驱动卸载、fltmc detach, FltDetachVolume, or FilterDetach时，volume instance需要被detach，通过调用minifilter的回调函数InstanceQueryTeardownCallback，查询驱动是否支持detach
teardown 操作流程如下: 
调用InstanceTeardownStartCallback回调，回调函数中需要完成:**complete all pending operations、 cancel or complete other work such as I/O requests generated by the minifilter driver, and stop queuing new work items**
在instance teardown过程中，所有正在执行的preoperation、postoperation回调函数继续正常执行，正在等postoperation回调的IO请求将被"drained" or canceled。
当所有outstanding IO请求全部完成，InstanceTeardownCompleteCallback就被执行，在这个函数中，关闭所有打开的文件
当instance的所有外部引用全都released后，filter manager删除对应context
volume instance完成torn down
(sc stop, net stop, or the service APIs), or through an explicit unload request (fltmc unload, FltUnloadFilter, or FilterUnload). 

**Processing I/O Operations**
filter manager为minifilter驱动简化了过滤IO操作，传统fsfilter需要正确处理所有IO请求，并转发给下层驱动、并正确处理pending request、同步、IO完成。minifilter只处理自己关心的IO操作。
当一个IO操作触发时，filter manager先调用minifilter的preoperation函数。preoperation函数中可以调用FltQueueDeferredIoWorkItem将operation queue到一个工作线程，并返回FLT_PREOP_PENDING，filter manager就会pending对应的IO操作。minifilter需要调用**FltCompletePendedPreOperation**恢复IO操作
若minifilter需要为每个instance管理一个IO操作cancel-safe队列，可以在InstanceSetupCallback回调函数中调用**FltCbdqInitialize**建立队列，通过调用**FltCbdqInsertIo**将IO请求插入队列。
在下层驱动完成IO操作时，会调用minifilter的postoperation回调函数，在DPC上下文中执行，

The filter manager calls a minifilter driver's postoperation callback routine for an I/O operation when lower filter drivers (legacy filters and minifilter drivers) have finished completion processing. 

In its postoperation callback routine, the minifilter driver can call FltDoCompletionProcessingWhenSafe to ensure that completion processing is performed at safe IRQL. Or it can queue the completion processing of the operation to a worker thread if needed by calling FltQueueDeferredIoWorkItem. After doing so, the minifilter driver returns FLT_POSTOP_MORE_PROCESSING_REQUIRED from its postoperation callback routine to halt the filter manager's completion processing for the I/O operation. To resume completion processing, the minifilter driver calls FltCompletePendedPostOperation from the worker thread. 

The filter manager provides support for queuing of "generic" work items – work items that are associated with a minifilter driver or minifilter driver instance rather than an I/O operation. A minifilter driver can insert a work item into a system work queue by calling FltQueueGenericWorkItem. This routine is similar to routines such as ExQueueWorkItem; for example, work items (allocated by calling FltAllocateGenericWorkItem) can be reused. However, FltQueueGenericWorkItem is safer for minifilter drivers to use, because the filter manager does not allow the minifilter driver or minifilter driver instance to unload while outstanding work items are still being processed. 

The filter manager also provides support for opportunistic lock (oplock) operations. For oplock operations, a minifilter driver can use such filter manager routines as FltInitializeOplock and FltOplockFsctrl, which are equivalent to the FsRtlInitializeOplock and FsRtlOplockFsctrl routines that are used by file systems and legacy filter drivers. 



Filter Manager Routines for Processing I/O Operations
The filter manager provides the following support routines for pending I/O in preoperation and postoperation callback routines: 

FltCompletePendedPostOperation 

FltCompletePendedPreOperation 

FltDoCompletionProcessingWhenSafe 

The following routines are used for queuing work items in preoperation and postoperation callback routines: 

FltAllocateDeferredIoWorkItem 

FltAllocateGenericWorkItem 

FltFreeDeferredIoWorkItem 

FltFreeGenericWorkItem 

FltQueueDeferredIoWorkItem 

FltQueueGenericWorkItem 

The following routines provide cancel-safe queue support: 

FltCbdqDisable 

FltCbdqEnable 

FltCbdqInitialize 

FltCbdqInsertIo 

FltCbdqRemoveIo 

FltCbdqRemoveNextIo 

The following routines provide oplock support: 

FltCheckOplock 

FltCurrentBatchOplock 

FltInitializeOplock 

FltOplockFsctrl 

FltOplockIsFastIoPossible 

FltUninitializeOplock 


Minifilter Driver Callback Routines for Processing I/O Operations
The following callback routines are stored in the FLT_OPERATION_REGISTRATION structure for each type of I/O operation that the minifilter driver handles: 





